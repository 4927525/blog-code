---
title: "Redis相关"
date: 2022-02-23T23:41:03+08:00
Description: ""
Tags: ["redis"]
Categories: ["mst"]
DisableComments: false
---
### Redis和Memcached相比，有哪些优势？

1. redis支持 string list set hash zset，memcached只支持string
2. redis支持数据持久化，可以把内存中的数据持久化到硬盘上，memcached不支持，只能存到内存中，重启就没有数据了。
3. redis使用的是单线程的多路IO复用机制

### 为什么用redis？

因为传统的关系型数据库已经不适用于所用的场景了，比如秒杀时的库存扣减，APP首页的访问流量高峰。很容易把数据库搞崩，所以就需要用到缓存中间件。目前市面上常用的中间件就是redis和mc。

## 2Redis为什么要把数据放到内存中？

如果不将数据放到内存中，磁盘的IO速度会严重影响性能。

### Redis为什么这么快？

1. redis的大部分操作在内存中完成，
2. redis是单线程的多路IO复用机制

### Redis数据类型有哪些？分别应用于哪些场景？

string：缓存，做计数器，分布式系统升自增长ID

list：异步队列，任务轮询，文章列表

hash：记录博客中某个博主的页面访问量，名字，信息

set：微博抽奖，QQ标签，共同关注 好友（交集）

sorted set：排行榜

### Redis的过期策略有哪些？

Redis过期策略采用的是惰性删除+定期删除策略。

### 大量key集中过期导致卡顿如何解决？

在设置过期时间时，增加一个随机时间

### 持久化方式有哪些？有什么区别？

RDB做全量持久化，AOF做增量持久化。因为RDB会耗费较长时间，不够实时，在停机的时候会导致大量丢失数据，所以需要AOF来配合使用。在redis实例重启时，会使用RDB持久化文件重新构建内存，再使用AOF重放近期的操作指令来实现完整恢复重启之前的状态。

### 缓存雪崩、击穿、穿透如何解决？

- 缓存雪崩：设置缓存时采用了相同的过期时间，导致缓存在某一时刻同时失效，全部转发到数据库中，导致数据库压力过大而崩溃。
  
  可以加给过期时间加一个随机数
  
- 缓存击穿：某一个key在某个时间点被高并发的访问。
  
  可以采用互斥锁/分布锁。让一个线程去查询，其他线程等待
  
- 缓存穿透：恶意请求不存在的key，导致缓存无法命中，每次都去查数据库
  
  如果数据库查不到就设置NULL并设置过期时间
  
  对参数做校验，不合法的参数直接return
  
  使用布隆过滤器判断数据是否存在
  

### 如何保证Redis命令的原子性？

原子性：多个命令要么全部成功，要么全部失败。
通过Lua脚本实现：多个操作写道lua脚本中，redis把整个lua脚本作为整体执行

### 有序集合是怎么排序的？

它给集合中的每一个元素设置分数，按照其分数进行排序，也不允许有重复值

### 缓存的原理

有缓存则读缓存，没缓存则读数据库然后做缓存

### MySQL里有2000w数据，redis中只存20w的数据，如何保证redis中的数据都是热点数据？

redis内存数据集大小上升到一定大小的时候，就会施行数据淘汰策略。

### 如果有大量的key需要设置同一时间过期，一般需要注意什么？

可能会出现缓存雪崩，我们一般需要在过期时间上加一个随机值。

### 那你使用过Redis分布式锁么，它是什么回事？

先拿setnx来争抢锁，抢到之后，再用expire给锁加一个过期时间防止锁忘记释放。

### 使用过Redis做异步队列么，你是怎么用的？

使用list最为队列，rpush生产消息，lpop消费消息。当lpop没有消息的时候，要适当sleep一会再试。

### 如果对方追问可不可以不用sleep呢？

list还有个指令叫**blpop**，在没有消息的时候，它会阻塞住直到消息到来。

### 如果对方接着追问能不能生产一次消费多次呢？

使用pub/sub主题订阅者模式，可以实现 1:N 的消息队列。

### 如果对方继续追问 pub/sub有什么缺点？

在消费者下线的情况下，生产的消息会丢失，得使用专业的消息队列如**RocketMQ**等。

### REDIS 的AOF选项有哪几种写入配置？

在redis.conf文件中，设置：appendonly yes（默认为no）

### 为什么AOF日志需要重写

当AOF很大的时候，再去追加是很慢的，这时可以把多条命令压缩成一条，这就是AOF重写

### 跳表原理

在原有的有序链表上增加了多级索引，通过索引来实现快速查询，提高搜索性能

### 布隆过滤器

场景：

- 字处理软件中，需要检查一个英语单词是否拼写正确
- 在 FBI，一个嫌疑人的名字是否已经在嫌疑名单上
- 在网络爬虫里，一个网址是否被访问过
- yahoo, gmail等邮箱垃圾邮件过滤功能

![img](https://images2015.cnblogs.com/blog/1030776/201701/1030776-20170106143141784-1475031003.png)

假设集合里面有3个元素{x, y, z}，哈希函数的个数为3。首先将位数组进行初始化，将里面每个位都设置位0。对于集合里面的每一个元素，将元素依次通过3个哈希函数进行映射，每次映射都会产生一个哈希值，这个值对应位数组上面的一个点，然后将位数组对应的位置标记为1。查询W元素是否存在集合中的时候，同样的方法将W通过哈希映射到位数组上的3个点。如果3个点的其中有一个点不为1，则可以判断该元素一定不存在集合中。反之，如果3个点都为1，则该元素可能存在集合中。

### redis做延迟队列/预约到点发短信的业务

zset, 要发送的内容id作为key, score是发送时间.

因为时间是有序的. 第一个没到发送时间,后面的肯定也没到

每次检测第一个., 如果没到发送时间, 休眠0.5秒. 否则就开始根据ID取出内容发送.

这样发送的内容都不在内存中这是分发器的实现，分发器将到时间了要发送的推到队列，由发送器去即时发送